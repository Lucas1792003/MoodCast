{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/waiya/Desktop/MoodCast/MoodCast/src/app/api/reverse-city/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\n\r\nexport const runtime = \"nodejs\"\r\n\r\nfunction pickFirst(addr: any, keys: string[]) {\r\n  for (const k of keys) {\r\n    const v = addr?.[k]\r\n    if (typeof v === \"string\" && v.trim()) return v.trim()\r\n  }\r\n  return null\r\n}\r\n\r\nfunction cleanName(s: string) {\r\n  return s\r\n    .replace(/\\bsubdistrict\\b/gi, \"\")\r\n    .replace(/\\bdistrict\\b/gi, \"\")\r\n    .replace(/\\bprovince\\b/gi, \"\")\r\n    .replace(/\\bstate\\b/gi, \"\")\r\n    .replace(/\\s+/g, \" \")\r\n    .replace(/\\s*,\\s*/g, \", \")\r\n    .trim()\r\n}\r\n\r\nfunction looksTooLocal(s: string) {\r\n  const t = s.toLowerCase()\r\n  return t.includes(\"subdistrict\") || t.includes(\"village\") || t.includes(\"neighbourhood\")\r\n}\r\n\r\nexport async function GET(req: NextRequest) {\r\n  const { searchParams } = new URL(req.url)\r\n  const lat = Number(searchParams.get(\"lat\"))\r\n  const lon = Number(searchParams.get(\"lon\"))\r\n\r\n  if (!Number.isFinite(lat) || !Number.isFinite(lon)) {\r\n    return NextResponse.json({ error: \"Invalid lat/lon\" }, { status: 400 })\r\n  }\r\n\r\n  // zoom=10 tends to be “city/region”, not street/subdistrict\r\n  const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`\r\n\r\n  const res = await fetch(url, {\r\n    headers: {\r\n      \"User-Agent\": \"MoodCast/1.0\",\r\n      \"Accept-Language\": \"en\",\r\n    },\r\n    cache: \"no-store\",\r\n  })\r\n\r\n  if (!res.ok) {\r\n    return NextResponse.json({ error: \"Reverse geocode failed\" }, { status: 502 })\r\n  }\r\n\r\n  const data: any = await res.json()\r\n  const addr = data?.address ?? {}\r\n\r\n  const country = cleanName(pickFirst(addr, [\"country\"]) || \"\")\r\n\r\n  // “City-ish” candidates\r\n  let city = pickFirst(addr, [\"city\", \"town\", \"municipality\", \"village\", \"county\", \"state_district\"]) || \"\"\r\n  let region = pickFirst(addr, [\"state\", \"region\", \"province\"]) || \"\"\r\n\r\n  city = cleanName(city)\r\n  region = cleanName(region)\r\n\r\n  // If city is too local (subdistrict-level), fall back to region as “city”\r\n  if (!city || looksTooLocal(city)) {\r\n    city = region || city\r\n  }\r\n\r\n  // Final query your app understands: City + Country (keep it simple for your DB)\r\n  const query = [city, country].filter(Boolean).join(\", \").trim() || \"Thailand\"\r\n  const label = query // what you show inside the search bar\r\n\r\n  return NextResponse.json({ city, region, country, query, label })\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEO,MAAM,UAAU;AAEvB,SAAS,UAAU,IAAS,EAAE,IAAc;IAC1C,KAAK,MAAM,KAAK,KAAM;QACpB,MAAM,IAAI,MAAM,CAAC,EAAE;QACnB,IAAI,OAAO,MAAM,YAAY,EAAE,IAAI,IAAI,OAAO,EAAE,IAAI;IACtD;IACA,OAAO;AACT;AAEA,SAAS,UAAU,CAAS;IAC1B,OAAO,EACJ,OAAO,CAAC,qBAAqB,IAC7B,OAAO,CAAC,kBAAkB,IAC1B,OAAO,CAAC,kBAAkB,IAC1B,OAAO,CAAC,eAAe,IACvB,OAAO,CAAC,QAAQ,KAChB,OAAO,CAAC,YAAY,MACpB,IAAI;AACT;AAEA,SAAS,cAAc,CAAS;IAC9B,MAAM,IAAI,EAAE,WAAW;IACvB,OAAO,EAAE,QAAQ,CAAC,kBAAkB,EAAE,QAAQ,CAAC,cAAc,EAAE,QAAQ,CAAC;AAC1E;AAEO,eAAe,IAAI,GAAgB;IACxC,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,IAAI,GAAG;IACxC,MAAM,MAAM,OAAO,aAAa,GAAG,CAAC;IACpC,MAAM,MAAM,OAAO,aAAa,GAAG,CAAC;IAEpC,IAAI,CAAC,OAAO,QAAQ,CAAC,QAAQ,CAAC,OAAO,QAAQ,CAAC,MAAM;QAClD,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAkB,GAAG;YAAE,QAAQ;QAAI;IACvE;IAEA,4DAA4D;IAC5D,MAAM,MAAM,CAAC,8DAA8D,EAAE,IAAI,KAAK,EAAE,IAAI,yBAAyB,CAAC;IAEtH,MAAM,MAAM,MAAM,MAAM,KAAK;QAC3B,SAAS;YACP,cAAc;YACd,mBAAmB;QACrB;QACA,OAAO;IACT;IAEA,IAAI,CAAC,IAAI,EAAE,EAAE;QACX,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAyB,GAAG;YAAE,QAAQ;QAAI;IAC9E;IAEA,MAAM,OAAY,MAAM,IAAI,IAAI;IAChC,MAAM,OAAO,MAAM,WAAW,CAAC;IAE/B,MAAM,UAAU,UAAU,UAAU,MAAM;QAAC;KAAU,KAAK;IAE1D,wBAAwB;IACxB,IAAI,OAAO,UAAU,MAAM;QAAC;QAAQ;QAAQ;QAAgB;QAAW;QAAU;KAAiB,KAAK;IACvG,IAAI,SAAS,UAAU,MAAM;QAAC;QAAS;QAAU;KAAW,KAAK;IAEjE,OAAO,UAAU;IACjB,SAAS,UAAU;IAEnB,0EAA0E;IAC1E,IAAI,CAAC,QAAQ,cAAc,OAAO;QAChC,OAAO,UAAU;IACnB;IAEA,gFAAgF;IAChF,MAAM,QAAQ;QAAC;QAAM;KAAQ,CAAC,MAAM,CAAC,SAAS,IAAI,CAAC,MAAM,IAAI,MAAM;IACnE,MAAM,QAAQ,MAAM,sCAAsC;;IAE1D,OAAO,gJAAY,CAAC,IAAI,CAAC;QAAE;QAAM;QAAQ;QAAS;QAAO;IAAM;AACjE"}}]
}