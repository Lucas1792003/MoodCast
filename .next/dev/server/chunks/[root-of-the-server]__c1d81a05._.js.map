{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/waiya/Desktop/MoodCast/MoodCast/src/app/api/weather/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\r\nimport type { WeatherResult } from \"@/lib/weather-types\"\r\n\r\nexport const runtime = \"nodejs\"\r\n\r\nfunction labelLooksWeak(label: string | null) {\r\n  if (!label) return true\r\n  const s = label.toLowerCase()\r\n  if (s.includes(\"subdistrict\")) return true\r\n  if (s.includes(\"district\") && !s.includes(\"city\")) return true\r\n  return false\r\n}\r\n\r\nasync function reverseLabel(lat: number, lon: number): Promise<string | null> {\r\n  try {\r\n    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lon}&zoom=14&addressdetails=1`\r\n    const res = await fetch(url, {\r\n      headers: {\r\n        \"User-Agent\": \"MoodCast/1.0\",\r\n        \"Accept-Language\": \"en\",\r\n      },\r\n      cache: \"no-store\",\r\n    })\r\n    if (!res.ok) return null\r\n    const data: any = await res.json()\r\n    const addr = data?.address ?? {}\r\n\r\n    const main =\r\n      addr.city ||\r\n      addr.town ||\r\n      addr.village ||\r\n      addr.hamlet ||\r\n      addr.suburb ||\r\n      addr.neighbourhood ||\r\n      null\r\n\r\n    const admin = addr.state || addr.county || addr.region || null\r\n    const country = addr.country || null\r\n\r\n    if (main) return [main, admin, country].filter(Boolean).join(\", \")\r\n    return data?.display_name ?? null\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\nasync function nearbyPoi(lat: number, lon: number): Promise<string | null> {\r\n  try {\r\n    const radius = 3000\r\n    const q = `\r\n[out:json][timeout:20];\r\n(\r\n  nwr(around:${radius},${lat},${lon})[name][amenity~\"university|college|school|hospital|clinic|restaurant|cafe|cinema|theatre|library|marketplace\"];\r\n  nwr(around:${radius},${lat},${lon})[name][shop~\"mall|supermarket|department_store\"];\r\n  nwr(around:${radius},${lat},${lon})[name][tourism~\"attraction|museum\"];\r\n  nwr(around:${radius},${lat},${lon})[name][leisure=\"park\"];\r\n);\r\nout center 80;\r\n`\r\n    const res = await fetch(\"https://overpass-api.de/api/interpreter\", {\r\n      method: \"POST\",\r\n      headers: { \"Content-Type\": \"text/plain;charset=UTF-8\", \"User-Agent\": \"MoodCast/1.0\" },\r\n      body: q,\r\n      cache: \"no-store\",\r\n    })\r\n    if (!res.ok) return null\r\n    const data: any = await res.json()\r\n    const els: any[] = Array.isArray(data?.elements) ? data.elements : []\r\n    if (els.length === 0) return null\r\n\r\n    const toRad = (d: number) => (d * Math.PI) / 180\r\n    const distM = (aLat: number, aLon: number, bLat: number, bLon: number) => {\r\n      const R = 6371000\r\n      const dLat = toRad(bLat - aLat)\r\n      const dLon = toRad(bLon - aLon)\r\n      const x =\r\n        Math.sin(dLat / 2) ** 2 +\r\n        Math.cos(toRad(aLat)) * Math.cos(toRad(bLat)) * Math.sin(dLon / 2) ** 2\r\n      return 2 * R * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x))\r\n    }\r\n\r\n    const scored = els\r\n      .map((el) => {\r\n        const name = el?.tags?.name\r\n        if (!name) return null\r\n        const elLat = typeof el.lat === \"number\" ? el.lat : el?.center?.lat\r\n        const elLon = typeof el.lon === \"number\" ? el.lon : el?.center?.lon\r\n        if (typeof elLat !== \"number\" || typeof elLon !== \"number\") return null\r\n        return { name, d: distM(lat, lon, elLat, elLon) }\r\n      })\r\n      .filter(Boolean) as { name: string; d: number }[]\r\n\r\n    scored.sort((a, b) => a.d - b.d)\r\n    return scored[0]?.name ?? null\r\n  } catch {\r\n    return null\r\n  }\r\n}\r\n\r\nconst numOrNull = (v: any): number | null => (typeof v === \"number\" && Number.isFinite(v) ? v : null)\r\n\r\nexport async function GET(req: Request) {\r\n  const { searchParams } = new URL(req.url)\r\n\r\n  const lat = Number(searchParams.get(\"lat\"))\r\n  const lon = Number(searchParams.get(\"lon\"))\r\n  const providedName = (searchParams.get(\"name\") ?? \"\").trim()\r\n\r\n  if (!Number.isFinite(lat) || !Number.isFinite(lon)) {\r\n    return NextResponse.json({ error: \"Invalid lat/lon\" }, { status: 400 })\r\n  }\r\n\r\n  const url =\r\n    `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}` +\r\n    `&current=` +\r\n    [\r\n      \"temperature_2m\",\r\n      \"relative_humidity_2m\",\r\n      \"apparent_temperature\",\r\n      \"dew_point_2m\",\r\n      \"weather_code\",\r\n      \"is_day\",\r\n      \"visibility\",\r\n      \"cloud_cover\",\r\n      \"pressure_msl\",\r\n      \"surface_pressure\",\r\n      \"wind_speed_10m\",\r\n      \"wind_direction_10m\",\r\n      \"wind_gusts_10m\",\r\n      \"precipitation\",\r\n      \"rain\",\r\n      \"showers\",\r\n      \"snowfall\",\r\n      \"uv_index\",\r\n      \"precipitation_probability\",\r\n    ].join(\",\") +\r\n    `&hourly=precipitation_probability&forecast_hours=1` +\r\n    `&daily=sunrise,sunset&forecast_days=1` +\r\n    `&timezone=auto&temperature_unit=fahrenheit&wind_speed_unit=mph`\r\n\r\n  const res = await fetch(url, { next: { revalidate: 300 } })\r\n  if (!res.ok) {\r\n    return NextResponse.json({ error: \"Weather fetch failed\" }, { status: 502 })\r\n  }\r\n\r\n  const data = await res.json()\r\n  const c = data?.current\r\n  if (!c) {\r\n    return NextResponse.json({ error: \"Missing current weather\" }, { status: 502 })\r\n  }\r\n\r\n  let locationName = providedName\r\n  if (!locationName) {\r\n    const rev = await reverseLabel(lat, lon)\r\n    if (labelLooksWeak(rev)) {\r\n      const poi = await nearbyPoi(lat, lon)\r\n      locationName = poi || rev || \"Near you\"\r\n    } else {\r\n      locationName = rev || \"Near you\"\r\n    }\r\n  }\r\n\r\n  const probFromCurrent = numOrNull(c.precipitation_probability)\r\n  const probFromHourly = numOrNull(data?.hourly?.precipitation_probability?.[0])\r\n  const precipitationProbability = probFromCurrent ?? probFromHourly\r\n\r\n  const out: WeatherResult = {\r\n    locationName,\r\n    temperature: c.temperature_2m,\r\n    feelsLike: c.apparent_temperature,\r\n    weatherCode: c.weather_code,\r\n    windSpeed: c.wind_speed_10m,\r\n    humidity: c.relative_humidity_2m,\r\n    visibility: c.visibility,\r\n    latitude: lat,\r\n    longitude: lon,\r\n    isDay: Boolean(c.is_day),\r\n    sunrise: data?.daily?.sunrise?.[0] ?? null,\r\n    sunset: data?.daily?.sunset?.[0] ?? null,\r\n    uvIndex: numOrNull(c.uv_index),\r\n    cloudCover: numOrNull(c.cloud_cover),\r\n    pressureMsl: numOrNull(c.pressure_msl),\r\n    surfacePressure: numOrNull(c.surface_pressure),\r\n    dewPoint: numOrNull(c.dew_point_2m),\r\n\r\n    precipitationProbability,\r\n    precipitation: numOrNull(c.precipitation),\r\n    rain: numOrNull(c.rain),\r\n    showers: numOrNull(c.showers),\r\n    snowfall: numOrNull(c.snowfall),\r\n\r\n    windGusts: numOrNull(c.wind_gusts_10m),\r\n    windDirection: numOrNull(c.wind_direction_10m),\r\n  }\r\n\r\n  return NextResponse.json(out)\r\n}\r\n"],"names":[],"mappings":"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"}}]
}